from django.shortcuts import render
from .models import Search
from bs4 import BeautifulSoup
#this is for adding %20 in the middle
from requests.compat import quote_plus
import requests
# Create your views here.

BASE_CRAIGSLIT_URL = 'https://losangeles.craigslist.org/search/sss?query={}'
BASE_IMAGE_URL = 'https://images.craigslist.org/{}_300x300.jpg'
def home_view(request):
    return render(request, "base.html")

def new_search(request):
    #search =  Search(search=request.POST['search'])
    #you can use below code to get post without model or form
    Search.objects.create(search='search')
    search = request.POST.get('search')
    url = BASE_CRAIGSLIT_URL.format(quote_plus(search))
    response = requests.get(url)
    data = response.text
    soup = BeautifulSoup(data, features='html.parser')
    post_listings = soup.find_all('li', {'class':'result-row'})
    final_postings = []
    no_result = ''


    for post in post_listings:
        # you need _ before class
        # you can get text between <a></a>
        post_title = post.find(class_='result-title').text
        post_url = post.find('a').get('href')

        if post.find(class_='result-price'):
            post_price = post.find(class_='result-price').text
        else:
            post_price = 'N/A'


        if post.find(class_='result-image').get('data-ids'):
            post_image_id = post.find(class_='result-image').get('data-ids').split(',')[0].split(':')[1]
            post_image_url = BASE_IMAGE_URL.format(post_image_id)

        else:
            post_image_url = 'data:image/jpeg;base64,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'

        final_postings.append((post_title, post_url, post_price, post_image_url))


    if final_postings == []:
        no_result ='Your search - '+search+'- did not match any documents'



    context = {'search': search,
               'final_postings':final_postings,
               'no_result':no_result}
    return render(request, 'new_search.html', context)